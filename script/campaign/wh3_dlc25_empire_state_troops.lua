empire_state_troops = {
	elspeth_key = "wh_main_emp_wissenland",
	gelt_key = "wh2_dlc13_emp_golden_order",

	unit_keys = {
		"wh2_dlc13_emp_art_mortar_ror_0",
		"wh2_dlc13_emp_cav_empire_knights_ror_0",
		"wh2_dlc13_emp_cav_empire_knights_ror_1",
		"wh2_dlc13_emp_cav_empire_knights_ror_2",
		"wh2_dlc13_emp_cav_outriders_ror_0",
		"wh2_dlc13_emp_cav_pistoliers_ror_0",
		"wh2_dlc13_emp_inf_crossbowmen_ror_0",
		"wh2_dlc13_emp_inf_greatswords_ror_0",
		"wh2_dlc13_emp_inf_halberdiers_ror_0",
		"wh2_dlc13_emp_inf_handgunners_ror_0",
		"wh2_dlc13_emp_inf_spearmen_ror_0",
		"wh2_dlc13_emp_inf_swordsmen_ror_0",
		"wh2_dlc13_emp_veh_steam_tank_ror_0"
	},

	locked = {
		["wh_main_emp_wissenland"] = {
			["wh2_dlc13_emp_inf_handgunners_ror_0"] = false,
			["wh2_dlc13_emp_inf_spearmen_ror_0"] = false,
			["wh2_dlc13_emp_inf_swordsmen_ror_0"] = false,
			["wh2_dlc13_emp_cav_outriders_ror_0"] = false,
			["wh2_dlc13_emp_cav_pistoliers_ror_0"] = false,
			["wh2_dlc13_emp_inf_crossbowmen_ror_0"] = false,
			["wh2_dlc13_emp_art_mortar_ror_0"] = false,
			["wh2_dlc13_emp_cav_empire_knights_ror_0"] = false,
			["wh2_dlc13_emp_cav_empire_knights_ror_1"] = false,
			["wh2_dlc13_emp_cav_empire_knights_ror_2"] = false,
			["wh2_dlc13_emp_inf_greatswords_ror_0"] = false,
			["wh2_dlc13_emp_inf_halberdiers_ror_0"] = false,
			["wh2_dlc13_emp_veh_steam_tank_ror_0"] = false
		},
		["wh2_dlc13_emp_golden_order"] = {
			["wh2_dlc13_emp_inf_handgunners_ror_0"] = false,
			["wh2_dlc13_emp_inf_spearmen_ror_0"] = false,
			["wh2_dlc13_emp_inf_swordsmen_ror_0"] = false,
			["wh2_dlc13_emp_cav_outriders_ror_0"] = false,
			["wh2_dlc13_emp_cav_pistoliers_ror_0"] = false,
			["wh2_dlc13_emp_inf_crossbowmen_ror_0"] = false,
			["wh2_dlc13_emp_art_mortar_ror_0"] = false,
			["wh2_dlc13_emp_cav_empire_knights_ror_0"] = false,
			["wh2_dlc13_emp_cav_empire_knights_ror_1"] = false,
			["wh2_dlc13_emp_cav_empire_knights_ror_2"] = false,
			["wh2_dlc13_emp_inf_greatswords_ror_0"] = false,
			["wh2_dlc13_emp_inf_halberdiers_ror_0"] = false,
			["wh2_dlc13_emp_veh_steam_tank_ror_0"] = false
		}
	},

	locked_tooltips = {
		["wh_main_emp_wissenland"] = {
			["wh2_dlc13_emp_cav_empire_knights_ror_1"] = "state_troop_lock_tooltip_elspeth_knights_of_morr",
			["wh2_dlc13_emp_veh_steam_tank_ror_0"] = "state_troop_lock_tooltip_elspeth_emperors_wrath",
		},
		["default"] = {
			["wh2_dlc13_emp_inf_handgunners_ror_0"] = "state_troop_lock_tooltip_marksman",
			["wh2_dlc13_emp_inf_spearmen_ror_0"] = "state_troop_lock_tooltip_spear",
			["wh2_dlc13_emp_inf_swordsmen_ror_0"] = "state_troop_lock_tooltip_sword",
			["wh2_dlc13_emp_cav_outriders_ror_0"] = "state_troop_lock_tooltip_riders",
			["wh2_dlc13_emp_cav_pistoliers_ror_0"] = "state_troop_lock_tooltip_riders",
			["wh2_dlc13_emp_inf_crossbowmen_ror_0"] = "state_troop_lock_tooltip_marksman",
			["wh2_dlc13_emp_art_mortar_ror_0"] = "state_troop_lock_tooltip_machines",
			["wh2_dlc13_emp_cav_empire_knights_ror_0"] = "state_troop_lock_tooltip_knights",
			["wh2_dlc13_emp_cav_empire_knights_ror_1"] = "state_troop_lock_tooltip_knights",
			["wh2_dlc13_emp_cav_empire_knights_ror_2"] = "state_troop_lock_tooltip_knights",
			["wh2_dlc13_emp_inf_greatswords_ror_0"] = "state_troop_lock_tooltip_sword",
			["wh2_dlc13_emp_inf_halberdiers_ror_0"] = "state_troop_lock_tooltip_spear",
			["wh2_dlc13_emp_veh_steam_tank_ror_0"] = "state_troop_lock_tooltip_machines"
		}
	},

	tech_unlocks = {
		["wh3_dlc25_tech_emp_state_troops_1"] = {
			"wh2_dlc13_emp_inf_swordsmen_ror_0",
			"wh2_dlc13_emp_inf_greatswords_ror_0"
		},
		["wh3_dlc25_tech_emp_state_troops_2"] = {
			"wh2_dlc13_emp_inf_spearmen_ror_0",
			"wh2_dlc13_emp_inf_halberdiers_ror_0"
		},
		["wh3_dlc25_tech_emp_state_troops_3"] = {
			"wh2_dlc13_emp_inf_crossbowmen_ror_0",
			"wh2_dlc13_emp_inf_handgunners_ror_0"
		},
		["wh3_dlc25_tech_emp_state_troops_4"] = {
			"wh2_dlc13_emp_art_mortar_ror_0",
			"wh2_dlc13_emp_veh_steam_tank_ror_0"
		},
		["wh3_dlc25_tech_emp_state_troops_5"] = {
			"wh2_dlc13_emp_cav_pistoliers_ror_0",
			"wh2_dlc13_emp_cav_outriders_ror_0"
		},
		["wh3_dlc25_tech_emp_state_troops_6"] = {
			"wh2_dlc13_emp_cav_empire_knights_ror_0",
			"wh2_dlc13_emp_cav_empire_knights_ror_1",
			"wh2_dlc13_emp_cav_empire_knights_ror_2"
		}
	},

	custom_unlocks = {
		["wh2_dlc13_emp_veh_steam_tank_ror_0"] = {
			building_key_1 = "wh_main_special_nuln_cannon_foundry",
			building_key_2 = "wh_main_special_nuln_gunnery_school",
			building_built = false,
			tech_unlocked = false
		},
		["wh2_dlc13_emp_cav_empire_knights_ror_1"] = {
			building_key = "wh3_dlc25_gom_temple_of_morr_1",
			building_built = false,
			tech_unlocked = false
		}
	},

	nuln_region_keys = {
		"wh3_main_chaos_region_nuln",
		"wh3_main_combi_region_nuln"
	}
}

function empire_state_troops:initialise()
	if cm:is_new_game() == true then
		local elspeth_faction_cqi = cm:get_faction(self.elspeth_key):command_queue_index()
		
		self:lock_all_units(self.elspeth_key, true)
		
		for _, unit in ipairs(self.unit_keys) do
			cm:add_units_to_faction_mercenary_pool(elspeth_faction_cqi, unit, 1)
		end

		if cm:get_campaign_name() == "main_warhammer" then
			local gelt_faction_cqi = cm:get_faction(self.gelt_key):command_queue_index()

			self:lock_all_units(self.gelt_key, true)

			for _, unit in ipairs(self.unit_keys) do
				cm:add_units_to_faction_mercenary_pool(gelt_faction_cqi, unit, 1)
			end
		end
	end

	core:add_listener(
		"ElspethStateTroopTurnStart",
		"FactionTurnStart",
		function(context)
			return context:faction():name() == self.elspeth_key
		end,
		function(context) 
			self:update_building_status()
			self:update_or_lock_unit(self.elspeth_key, "wh2_dlc13_emp_veh_steam_tank_ror_0")
			self:update_or_lock_unit(self.elspeth_key, "wh2_dlc13_emp_cav_empire_knights_ror_1")
		end, 
		true
	)

	core:add_listener(
		"listener_salvage_unit_upgrade_tech",
		"ResearchCompleted",
		function(context)
			return self.tech_unlocks[context:technology()] ~= nil
		end,
		function(context)
			local tech = context:technology()
			local faction_key = context:faction():name()

			if self.tech_unlocks[tech] then
				for _, unit in ipairs(self.tech_unlocks[tech]) do
					if self.custom_unlocks[unit] then
						self.custom_unlocks[unit].tech_unlocked = true
					end
				end
			end

			for _, unit in ipairs(self.tech_unlocks[tech]) do
				self:change_unit_lock_status(faction_key, unit, false)
			end
		end,
		true
	)
end

function empire_state_troops:lock_all_units(faction_key, lock)
	-- can be used to lock or unlock all

	for _, unit in ipairs(self.unit_keys) do
		self:change_unit_lock_status(faction_key, unit, lock)
	end
end

function empire_state_troops:update_or_lock_unit(faction_key, unit_key)
	local unit_data = self.custom_unlocks[unit_key]

	if unit_data.building_built or unit_data.tech_unlocked then
		-- unlock unit and update replenishment time
		self:change_unit_lock_status(faction_key, unit_key, false)
	else
		-- lock unit
		self:change_unit_lock_status(faction_key, unit_key, true)
	end	
end

function empire_state_troops:change_unit_lock_status(faction_key, unit, lock)
	if lock == true and self.locked[faction_key][unit] == false then
		self.locked[faction_key][unit] = true

		if self.locked_tooltips[faction_key] and self.locked_tooltips[faction_key][unit] then
			cm:add_event_restricted_unit_record_for_faction(unit, faction_key, self.locked_tooltips[faction_key][unit])
		else
			cm:add_event_restricted_unit_record_for_faction(unit, faction_key, self.locked_tooltips.default[unit])
		end
	elseif lock == false and self.locked[faction_key][unit] == true then
		self.locked[faction_key][unit] = false
		cm:remove_event_restricted_unit_record_for_faction(unit, faction_key)
	end
end

function empire_state_troops:update_building_status()
	local wissenland = cm:get_faction(self.elspeth_key)
	local foreign_slot_list = wissenland:foreign_slot_managers()

	self.custom_unlocks["wh2_dlc13_emp_cav_empire_knights_ror_1"].building_built = false
	self.custom_unlocks["wh2_dlc13_emp_veh_steam_tank_ror_0"].building_built = false

	for _, region_key in pairs(self.nuln_region_keys) do
		local region = cm:get_region(region_key)
		
		if region ~= false and region:owning_faction():name() == self.elspeth_key then
			if region:building_exists(self.custom_unlocks["wh2_dlc13_emp_veh_steam_tank_ror_0"].building_key_1) then
				self.custom_unlocks["wh2_dlc13_emp_veh_steam_tank_ror_0"].building_built = true
				break
			elseif region:building_exists(self.custom_unlocks["wh2_dlc13_emp_veh_steam_tank_ror_0"].building_key_2) then
				self.custom_unlocks["wh2_dlc13_emp_veh_steam_tank_ror_0"].building_built = true
				break
			end
		end
	end

	for i = 0, foreign_slot_list:num_items() - 1 do
		local foreign_slot = foreign_slot_list:item_at(i)
		local foreign_building_slot_list = foreign_slot:slots()

		for j = 0, foreign_building_slot_list:num_items() - 1 do
			local building_slot = foreign_building_slot_list:item_at(j)

			if(building_slot:has_building() and building_slot:building() == self.custom_unlocks["wh2_dlc13_emp_cav_empire_knights_ror_1"].building_key) then
				self.custom_unlocks["wh2_dlc13_emp_cav_empire_knights_ror_1"].building_built = true
				return
			end
		end
	end
end


--------------------- SAVE/LOAD ---------------------

cm:add_saving_game_callback(
	function(context)
		cm:save_named_value("empire_state_troops.locked", empire_state_troops.locked, context)
		cm:save_named_value("empire_state_troops.custom_unlocks", empire_state_troops.custom_unlocks, context)
	end
)

cm:add_loading_game_callback(
	function(context)
		if not cm:is_new_game() then
			empire_state_troops.locked = cm:load_named_value("empire_state_troops.locked", empire_state_troops.locked, context)
			empire_state_troops.custom_unlocks = cm:load_named_value("empire_state_troops.custom_unlocks", empire_state_troops.custom_unlocks, context)
		end
	end
)