da_plan = {
	faction_key = "wh3_dlc26_grn_gorbad_ironclaw",
	planz = {
		resource_key = "wh3_dlc26_grn_yooreeka",
		factors = {
			gained = "battles"
		}
	},
	unequip_incident = "wh3_dlc26_da_plan_tactic_unequipped",
	unlocked_tactics = {
		-- Starting tactics, the rest are added during the game.
		"wh3_dlc26_force_initiative_grn_da_plan_light_em_up_1",
		"wh3_dlc26_force_initiative_grn_da_plan_orcs_are_da_best_1",
		"wh3_dlc26_force_initiative_grn_da_plan_erd_mentality_1",
		"wh3_dlc26_force_initiative_grn_da_plan_netted_targets_1"
	},
	missions = {
		all = {
			"wh3_dlc26_force_initiative_grn_da_plan_cheerleadaz_3",
			"wh3_dlc26_force_initiative_grn_da_plan_broodmothers_3",
			"wh3_dlc26_force_initiative_grn_da_plan_eat_da_runts_2",
			"wh3_dlc26_force_initiative_grn_da_plan_load_yerself_3",
			"wh3_dlc26_force_initiative_grn_da_plan_suprise_savagery_2",
			"wh3_dlc26_force_initiative_grn_da_plan_raidin_parties_1",
			"wh3_dlc26_force_initiative_grn_da_plan_eavy_metal_marchin_3",
			"wh3_dlc26_force_initiative_grn_da_plan_alpha_amma_2",
			"wh3_dlc26_force_initiative_grn_da_plan_da_black_bastion_2",
			"wh3_dlc26_force_initiative_grn_da_plan_drink_an_drive_2",
			"wh3_dlc26_force_initiative_grn_da_plan_fly_at_da_smoke_3",
			"wh3_dlc26_force_initiative_grn_da_plan_shoot_da_runts_1",
			"wh3_dlc26_force_initiative_grn_da_plan_stick_em_like_pigs_2",
			"wh3_dlc26_force_initiative_grn_da_plan_drag_da_wagonz_2",
			"wh3_dlc26_force_initiative_grn_da_plan_block_an_smash_1",
			"wh3_dlc26_force_initiative_grn_da_plan_cut_da_chains_3",
			"wh3_dlc26_force_initiative_grn_da_plan_earthquake_2",
			"wh3_dlc26_force_initiative_grn_da_plan_keep_em_ungry_3",
			"wh3_dlc26_force_initiative_grn_da_plan_lead_da_charge_2",
			"wh3_dlc26_force_initiative_grn_da_plan_little_wont_urt_1",
			"wh3_dlc26_force_initiative_grn_da_plan_stinkee_arrers_3",
			"wh3_dlc26_force_initiative_grn_da_plan_arrer_catcha_1",
			"wh3_dlc26_force_initiative_grn_da_plan_webweavin_1",
			"wh3_dlc26_force_initiative_grn_da_plan_keep_bossin_2",
			"wh3_dlc26_force_initiative_grn_da_plan_shot_in_da_dark_2",
			"wh3_dlc26_force_initiative_grn_da_plan_get_dem_from_below_2",
			"wh3_dlc26_force_initiative_grn_da_plan_power_of_da_waaagh_1",
			"wh3_dlc26_force_initiative_grn_da_plan_stompin_ground_2",
			"wh3_dlc26_force_initiative_grn_da_plan_splode_da_big_one_3",
			"wh3_dlc26_force_initiative_grn_da_plan_regimental_1",
			"wh3_dlc26_force_initiative_grn_da_plan_da_greatest_warlord_2",
			"wh3_dlc26_force_initiative_grn_da_plan_goin_commando_2",
			"wh3_dlc26_force_initiative_grn_da_plan_master_planner_3",
			"wh3_dlc26_force_initiative_grn_da_plan_fungus_farms_2"
		},
		non_scripted = {
			"wh3_dlc26_force_initiative_grn_da_plan_cheerleadaz_3",
			"wh3_dlc26_force_initiative_grn_da_plan_broodmothers_3",
			"wh3_dlc26_force_initiative_grn_da_plan_eat_da_runts_2",
			"wh3_dlc26_force_initiative_grn_da_plan_load_yerself_3",
			"wh3_dlc26_force_initiative_grn_da_plan_suprise_savagery_2",
			"wh3_dlc26_force_initiative_grn_da_plan_raidin_parties_1",
			"wh3_dlc26_force_initiative_grn_da_plan_eavy_metal_marchin_3",
			"wh3_dlc26_force_initiative_grn_da_plan_alpha_amma_2",
			"wh3_dlc26_force_initiative_grn_da_plan_da_black_bastion_2",
			"wh3_dlc26_force_initiative_grn_da_plan_drink_an_drive_2",
			"wh3_dlc26_force_initiative_grn_da_plan_fly_at_da_smoke_3",
			"wh3_dlc26_force_initiative_grn_da_plan_shoot_da_runts_1",
			"wh3_dlc26_force_initiative_grn_da_plan_stick_em_like_pigs_2",
			"wh3_dlc26_force_initiative_grn_da_plan_drag_da_wagonz_2",
			"wh3_dlc26_force_initiative_grn_da_plan_block_an_smash_1",
			"wh3_dlc26_force_initiative_grn_da_plan_cut_da_chains_3",
			"wh3_dlc26_force_initiative_grn_da_plan_earthquake_2",
			"wh3_dlc26_force_initiative_grn_da_plan_keep_em_ungry_3",
			"wh3_dlc26_force_initiative_grn_da_plan_lead_da_charge_2",
			"wh3_dlc26_force_initiative_grn_da_plan_little_wont_urt_1",
			"wh3_dlc26_force_initiative_grn_da_plan_stinkee_arrers_3",
			"wh3_dlc26_force_initiative_grn_da_plan_fungus_farms_2",
			"wh3_dlc26_force_initiative_grn_da_plan_arrer_catcha_1",
			"wh3_dlc26_force_initiative_grn_da_plan_keep_bossin_2",
			"wh3_dlc26_force_initiative_grn_da_plan_webweavin_1",
			"wh3_dlc26_force_initiative_grn_da_plan_get_dem_from_below_2",
			"wh3_dlc26_force_initiative_grn_da_plan_goin_commando_2"
		},
		scripted = {
			-- Win battles with Gorbad
			gorbad_battles = {
				mission = "wh3_dlc26_force_initiative_grn_da_plan_master_planner_3",
				target = 50,
				count = 0,
				complete = false
			},		

			-- Ambush
			ambush = {
				missions = {
					"wh3_dlc26_force_initiative_grn_da_plan_shot_in_da_dark_2"
				},
				targets = {
					["wh3_dlc26_force_initiative_grn_da_plan_shot_in_da_dark_2"] = 3
				},
				counts = {
					["wh3_dlc26_force_initiative_grn_da_plan_shot_in_da_dark_2"] = 0
				},
				complete = {
					["wh3_dlc26_force_initiative_grn_da_plan_shot_in_da_dark_2"] = false
				}
			},
			
			-- Cast Waaagh Spells
			waaagh_spells = {
				missions = {
					"wh3_dlc26_force_initiative_grn_da_plan_power_of_da_waaagh_1",
					"wh3_dlc26_force_initiative_grn_da_plan_stompin_ground_2",
					"wh3_dlc26_force_initiative_grn_da_plan_splode_da_big_one_3"
				},
				spells = {
					"wh_main_spell_big_waaagh_brain_bursta",
					"wh_main_spell_big_waaagh_brain_bursta_upgraded",
					"wh_main_spell_big_waaagh_eadbutt",
					"wh_main_spell_big_waaagh_eadbutt_upgraded",
					"wh_main_spell_big_waaagh_ere_we_go",
					"wh_main_spell_big_waaagh_fists_of_gork",
					"wh_main_spell_big_waaagh_foot_of_gork",
					"wh_main_spell_big_waaagh_foot_of_gork_upgraded",
					"wh_main_spell_big_waaagh_gaze_of_mork",
					"wh_main_spell_big_waaagh_gaze_of_mork_upgraded",
					"wh_main_spell_lil_waaagh_curse_of_da_bad_moon",
					"wh_main_spell_lil_waaagh_curse_of_da_bad_moon_upgraded",
					"wh_main_spell_lil_waaagh_gorkll_fix_it",
					"wh_main_spell_lil_waaagh_itchy_nuisance",
					"wh_main_spell_lil_waaagh_night_shroud",
					"wh_main_spell_lil_waaagh_night_shroud_upgraded",
					"wh_main_spell_lil_waaagh_sneaky_stabbin",
					"wh_main_spell_lil_waaagh_vindictive_glare",
					"wh_main_spell_lil_waaagh_vindictive_glare_upgraded"
				},
				targets = {
					["wh3_dlc26_force_initiative_grn_da_plan_power_of_da_waaagh_1"] = 10,
					["wh3_dlc26_force_initiative_grn_da_plan_stompin_ground_2"] = 50,
					["wh3_dlc26_force_initiative_grn_da_plan_splode_da_big_one_3"] = 100
				},
				counts = {
					["wh3_dlc26_force_initiative_grn_da_plan_power_of_da_waaagh_1"] = 0,
					["wh3_dlc26_force_initiative_grn_da_plan_stompin_ground_2"] = 0,
					["wh3_dlc26_force_initiative_grn_da_plan_splode_da_big_one_3"] = 0
				},
				complete = {
					["wh3_dlc26_force_initiative_grn_da_plan_power_of_da_waaagh_1"] = false,
					["wh3_dlc26_force_initiative_grn_da_plan_stompin_ground_2"] = false,
					["wh3_dlc26_force_initiative_grn_da_plan_splode_da_big_one_3"] = false
				}
			},
			
			-- Trigger Waaagh
			waaagh = {
				ritual = "wh2_main_ritual_grn_waaagh",
				missions = {
					"wh3_dlc26_force_initiative_grn_da_plan_regimental_1",
					"wh3_dlc26_force_initiative_grn_da_plan_da_greatest_warlord_2"
				},
				targets = {
					["wh3_dlc26_force_initiative_grn_da_plan_regimental_1"] = 1,
					["wh3_dlc26_force_initiative_grn_da_plan_da_greatest_warlord_2"] = 3
				},
				counts = {
					["wh3_dlc26_force_initiative_grn_da_plan_regimental_1"] = 0,
					["wh3_dlc26_force_initiative_grn_da_plan_da_greatest_warlord_2"] = 0
				},
				complete = {
					["wh3_dlc26_force_initiative_grn_da_plan_regimental_1"] = false,
					["wh3_dlc26_force_initiative_grn_da_plan_da_greatest_warlord_2"] = false
				}
			}
		}
	}
}

function da_plan:initialise()
	local faction = cm:get_faction(self.faction_key)
	if not faction then return end
	
	if faction:is_human() then
		if cm:is_new_game() == true then
			for _, mission in ipairs(self.missions.non_scripted) do
				cm:trigger_mission(self.faction_key, mission, true, true)
			end
		end
		
		self:unlock_valid_initiatives_for_all_generals()
		self:trigger_gorbad_victory_missions()
		self:trigger_ambush_missions()
		self:trigger_waaaagh_spell_missions()
		self:trigger_waaagh_missions()
	end

	core:add_listener(
		"DaPlanPlanzGain",
		"CharacterCompletedBattle",
		function(context)
			-- Did Gorbad win a battle
			local character = context:character()
			return character:won_battle() and character:faction():name() == self.faction_key and character:is_faction_leader()
		end,
		function()
			cm:faction_add_pooled_resource(self.faction_key, self.planz.resource_key, self.planz.factors.gained, 2)
		end,
		true
	)

	core:add_listener(
		"DaPlanTacticUnlock",
		"MissionSucceeded",
		function(context)
			for _, mission_key in ipairs(self.missions.all) do
				if mission_key == context:mission():mission_record_key() then
					return true
				end
			end

			return false
		end,
		function(context)
			local tactic = context:mission():mission_record_key()
			table.insert(self.unlocked_tactics, tactic)
			self:unlock_valid_initiatives_for_all_generals()

			cm:trigger_incident(self.faction_key, tactic, true, true)
			core:trigger_event("ScriptedDaPlanTacticUnlockedByChallange", context:faction())
		end,
		true
	)

	core:add_listener(
		"DaPlanNewTurn",
		"FactionTurnStart",
		function(context)
			return context:faction():name() == self.faction_key
		end,
		function(context)
			cm:callback(function()
				self:unlock_valid_initiatives_for_all_generals()
			end, 1)	
		end,
		true
	)

	core:add_listener(
		"DaPlanNewCharacter",
		"CharacterRecruited",
		function(context)
			return context:character():faction():name() == self.faction_key
		end,
		function(context)
			cm:callback(function()
				self:unlock_valid_initiatives_for_all_generals()
			end, 1)	
		end,
		true
	)

	core:add_listener(
		"DaPlanConfederation",
		"FactionJoinsConfederation",
		function(context)
			return context:confederation():name() == self.faction_key
		end,
		function(context)
			cm:callback(function()
				self:unlock_valid_initiatives_for_all_generals()
			end, 1)	
		end,
		true
	)

	core:add_listener(
		"DaPlanUnequippedTactic",
		"CharacterInitiativeActivationChangedEvent",
		function(context)
			return string.find(context:initiative():record_key(), "da_plan")
		end,
		function(context)
			if context:automated() then
				-- Tactic was automatically removed, not manually.
				local faction_cqi = cm:get_faction(self.faction_key):command_queue_index()
				local character_cqi = context:character():command_queue_index()
				cm:trigger_incident_with_targets(faction_cqi, self.unequip_incident, 0, 0, character_cqi, 0, 0, 0)
			end
		end,
		true
	)
end

-- Gorbad battles
function da_plan:trigger_gorbad_victory_missions()
	local mission_data = self.missions.scripted.gorbad_battles

	if mission_data.complete == false then
		local mission_key = mission_data.mission
		local mm = mission_manager:new(self.faction_key, mission_key)

		mm:add_new_scripted_objective(
			"mission_text_text_" .. mission_key,
			"CharacterCompletedBattle",
			function(context)
				-- Did Gorbad win a battle
				local character = context:character()

				if character:won_battle() and character:faction():name() == self.faction_key and character:is_faction_leader() then
					mission_data.count = mission_data.count + 1
					out.design("gorbad is now at: "..mission_data.count.." battles")
					mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.count, mission_data.target, mission_key)
				end

				if mission_data.count >= mission_data.target then
					mission_data.complete = true
					return true
				end
			end,
			mission_key
		)

		mm:add_payload("effect_bundle{bundle_key wh_main_bundle_dummy;turns 0;}")
		mm:set_should_whitelist(false)
		
		if cm:mission_is_active_for_faction(cm:get_faction(self.faction_key), mission_key) == false then
			mm:trigger()
		end

		mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.count, mission_data.target, mission_key)
	end
end

-- Ambush
function da_plan:trigger_ambush_missions()
	local mission_data = self.missions.scripted.ambush

	for _, mission_key in ipairs(mission_data.missions) do
		if mission_data.complete[mission_key] == false then
			local mm = mission_manager:new(self.faction_key, mission_key)

			mm:add_new_scripted_objective(
				"mission_text_text_" .. mission_key,
				"CharacterCompletedBattle",
				function(context)
					local character = context:character()

					if character:faction():name() == self.faction_key and character:won_battle() and context:pending_battle():ambush_battle() then
						mission_data.counts[mission_key] = mission_data.counts[mission_key] + 1
						mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.counts[mission_key], mission_data.targets[mission_key], mission_key)
					end

					if mission_data.counts[mission_key] >= mission_data.targets[mission_key] then
						mission_data.complete[mission_key] = true
						return true
					end
				end,
				mission_key
			)

			mm:add_payload("effect_bundle{bundle_key wh_main_bundle_dummy;turns 0;}")
			mm:set_should_whitelist(false)

			if cm:mission_is_active_for_faction(cm:get_faction(self.faction_key), mission_key) == false then
				mm:trigger()
			end

			mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.counts[mission_key], mission_data.targets[mission_key], mission_key)
		end
	end
end

function da_plan:unlock_valid_initiatives_for_all_generals()
	local faction = cm:get_faction(self.faction_key)
	local mf_list = faction:military_force_list()

	for i = 0, mf_list:num_items() - 1 do 
		local mf = mf_list:item_at(i)

		if mf:has_general() and mf:is_armed_citizenry() == false then
			local general = mf:general_character()

			for _, initiative in ipairs(self.unlocked_tactics) do
				local initiative_set = general:character_details():lookup_character_initiative_set_by_key("wh3_dlc26_force_initiative_grn_da_plan")
			
				cm:toggle_initiative_script_locked(initiative_set, initiative, false)
			end
		end
	end
end

-- Cast Waaagh Spells
function da_plan:trigger_waaaagh_spell_missions()
	local mission_data = self.missions.scripted.waaagh_spells

	for _, mission_key in ipairs(mission_data.missions) do
		if mission_data.complete[mission_key] == false then
			local mm = mission_manager:new(self.faction_key, mission_key)

			mm:add_new_scripted_objective(
				"mission_text_text_" .. mission_key,
				"CharacterCompletedBattle",
				function(context)
					if context:character():faction():name() == self.faction_key then
						local pb = context:pending_battle()
						local faction_cqi = cm:get_faction(self.faction_key):command_queue_index()

						-- Waaagh Spells
						for _, spell in ipairs(mission_data.spells) do
							local spell_count = pb:get_how_many_times_ability_has_been_used_in_battle(faction_cqi, spell)
							mission_data.counts[mission_key] = mission_data.counts[mission_key] + spell_count
							mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.counts[mission_key], mission_data.targets[mission_key], mission_key)
						end

						if mission_data.counts[mission_key] >= mission_data.targets[mission_key] then
							mission_data.complete[mission_key] = true
							return true
						end
					end
				end,
				mission_key
			)

			mm:add_payload("effect_bundle{bundle_key wh_main_bundle_dummy;turns 0;}")
			mm:set_should_whitelist(false)
			
			if cm:mission_is_active_for_faction(cm:get_faction(self.faction_key), mission_key) == false then
				mm:trigger()
			end

			mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.counts[mission_key], mission_data.targets[mission_key], mission_key)
		end
	end
end

-- Trigger Waaagh
function da_plan:trigger_waaagh_missions()
	local mission_data = self.missions.scripted.waaagh

	for _, mission_key in ipairs(mission_data.missions) do
		if mission_data.complete[mission_key] == false then
			local mm = mission_manager:new(self.faction_key, mission_key)

			mm:add_new_scripted_objective(
				"mission_text_text_" .. mission_key,
				"RitualCompletedEvent",
				function(context)
					if context:ritual():ritual_key() == self.missions.scripted.waaagh.ritual then
						mission_data.counts[mission_key] = mission_data.counts[mission_key] + 1

						mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.counts[mission_key], mission_data.targets[mission_key], mission_key)

						if mission_data.counts[mission_key] >= mission_data.targets[mission_key] then
							mission_data.complete[mission_key] = true
							return true
						end
					end
				end,
				mission_key
			)

			mm:add_payload("effect_bundle{bundle_key wh_main_bundle_dummy;turns 0;}")
			mm:set_should_whitelist(false)
			
			if cm:mission_is_active_for_faction(cm:get_faction(self.faction_key), mission_key) == false then
				mm:trigger()
			end

			mm:update_scripted_objective_text("mission_text_text_"..mission_key, mission_data.counts[mission_key], mission_data.targets[mission_key], mission_key)
		end
	end
end



--------------------------------------------------------------
----------------------- SAVING / LOADING ---------------------
--------------------------------------------------------------

cm:add_saving_game_callback(
	function(context)
		cm:save_named_value("da_plan.missions.scripted", da_plan.missions.scripted, context)
		cm:save_named_value("da_plan.unlocked_tactics", da_plan.unlocked_tactics, context)
	end
)

cm:add_loading_game_callback(
	function(context)
		if cm:is_new_game() == false then
			da_plan.missions.scripted = cm:load_named_value("da_plan.missions.scripted", da_plan.missions.scripted, context)
			da_plan.unlocked_tactics = cm:load_named_value("da_plan.unlocked_tactics", da_plan.unlocked_tactics, context)
		end
	end
)